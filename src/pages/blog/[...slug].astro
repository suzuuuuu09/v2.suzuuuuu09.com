---
import { render } from "astro:content";
import { Flex, styled as s } from "styled-system/jsx";
import BlogLayout from "@/layouts/BlogLayout.astro";
import ArticleInfo from "@/components/features/blog/ArticleInfo.astro";
import TableOfContents from "@/components/features/blog/TableOfContents.astro";
import SideArticle from "@/components/features/blog/SideArticle.astro";
import ShareMenu from "@/components/features/blog/ShareMenu.astro";
import { getBlogPosts } from "@/lib/post";
import Discussion from "@/components/features/blog/Discussion";

export async function getStaticPaths() {
	const blogEntries = await getBlogPosts();
	return blogEntries.map((entry) => ({
		params: { slug: entry.data.slug },
		props: { entry },
	}));
}

const { slug } = Astro.params;
let entry = Astro.props.entry;

// SSRãƒ¢ãƒ¼ãƒ‰ã§entryãŒæ¸¡ã•ã‚Œãªã„å ´åˆã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¤œç´¢
if (!entry) {
	const blogEntries = await getBlogPosts();
	const foundEntry = blogEntries.find((e) => (e.data.slug ?? e.id) === slug);

	if (!foundEntry) {
		return Astro.redirect("/404");
	}

	entry = foundEntry;
}

const { Content, headings } = await render(entry);

// ãƒ–ãƒ­ã‚°ã®æƒ…å ±
const articleInfo = {
	title: entry.data.title,
	slug: entry.data.slug,
	publishDate: entry.data.publishDate,
	updateDate: entry.data.updateDate,
	tags: entry.data.tags || [],
	emoji: entry.data.emoji || "ğŸ“",
	description: entry.data.description || "",
	content: entry.body, // èª­äº†æ™‚é–“è¨ˆç®—ç”¨
};
---

<BlogLayout
  title={entry.data.title}
  headings={headings}
  frontmatter={articleInfo}
  collection="blog"
>
  <ArticleInfo {...articleInfo} />
  <Flex flexDir={{ base: "column", lg: "row" }} gap={{ base: "6", lg: "8" }}>
    <s.article className="markdown-content" flex="1" minW="0">
      <Content />
			<Discussion client:load />
			<SideArticle slug={entry.data.slug} />
    </s.article>

		<ShareMenu
			title={articleInfo.title}
			slug={articleInfo.slug}
			description={articleInfo.description}
			visible="base"
			collection="blog"
		/>

    <s.aside 
			w={{ base: "100%", lg: "72" }}
      order={{ base: -1, lg: 1 }} 
      display="flex" 
      flexDir="column" 
      gap="4"
      position={{ base: "relative", lg: "sticky" }}
      top={{ lg: "24" }}
      alignSelf="flex-start"
    >
      <TableOfContents headings={headings} />
			<ShareMenu
				title={articleInfo.title}
				slug={articleInfo.slug}
				description={articleInfo.description}
				visible="lg"
				collection="blog"
			/>
    </s.aside>
  </Flex>
</BlogLayout>
