---
import { render } from "astro:content";
import { Flex, styled as s } from "styled-system/jsx";
import BlogLayout from "@/layouts/BlogLayout.astro";
import ProductInfo from "@/components/features/product/ProductInfo.astro";
import TableOfContents from "@/components/features/blog/TableOfContents.astro";
import SideArticle from "@/components/features/blog/SideArticle.astro";
import ShareMenu from "@/components/features/blog/ShareMenu.astro";
import { getProductPosts } from "@/lib/post";
import Discussion from "@/components/features/blog/Discussion";

export async function getStaticPaths() {
	const productEntries = await getProductPosts();
	return productEntries.map((entry) => ({
		params: { slug: entry.data.slug },
		props: { entry },
	}));
}

const { slug } = Astro.params;
let entry = Astro.props.entry;

// SSRモードでentryが渡されない場合、コレクションから検索
if (!entry) {
	const productEntries = await getProductPosts();
	const foundEntry = productEntries.find((e) => (e.data.slug ?? e.id) === slug);

	if (!foundEntry) {
		return Astro.redirect("/404");
	}

	entry = foundEntry;
}

const { Content, headings } = await render(entry);

const articleInfo = {
	title: entry.data.title,
	slug: entry.data.slug,
	publishDate: entry.data.publishDate,
	updateDate: entry.data.updateDate,
	tags: entry.data.tags || [],
	thumbnail: entry.data.thumbnail || "",
	description: entry.data.description || "",
	content: entry.body, // 読了時間計算用
};
---

<BlogLayout
  title={entry.data.title}
  headings={headings}
  frontmatter={articleInfo}
  collection="product"
>
  <ProductInfo {...articleInfo} />

  <Flex flexDir={{ base: "column", lg: "row" }} gap={{ base: "6", lg: "8" }}>
    <s.article
      flex="1"
      minW="0"
      display="flex"
      flexDir="column"
      order={{ base: 2, lg: 1 }}
    >
      <s.div className="markdown-content" order="1">
        <Content />
      </s.div>

      <s.nav order="2">
        <ShareMenu
          title={articleInfo.title}
          slug={articleInfo.slug}
          description={articleInfo.description}
          collection="product"
          visible="base"
        />
      </s.nav>

      <s.section order="3">
        <Discussion client:visible />
      </s.section>

      <s.section order="4">
        <SideArticle slug={entry.data.slug} collection="product" />
      </s.section>
    </s.article>

    <s.aside
      w={{ base: "100%", lg: "72" }}
      order={{ base: 1, lg: 2 }}
      display="flex"
      flexDir="column"
      gap="4"
      position={{ base: "relative", lg: "sticky" }}
      top={{ lg: "24" }}
      alignSelf="flex-start"
    >
      <TableOfContents headings={headings} />

      <s.nav>
        <ShareMenu
          title={articleInfo.title}
          slug={articleInfo.slug}
          description={articleInfo.description}
          visible="lg"
          collection="product"
        />
      </s.nav>
    </s.aside>
  </Flex>
</BlogLayout>
